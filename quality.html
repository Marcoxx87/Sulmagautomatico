<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Segnalazioni Qualità – Sulmona</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --gold:#f2b400; --gold-dark:#c99200; --red:#d0352d; --red-dark:#a12620;
      --ink:#0f172a; --bg:#fff7ea; --card:#ffffff; --ring:#e6e2d6; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#fff,#fff7ea)}

    .topbar{position:sticky;top:0;z-index:10;background:var(--gold);color:#111;border-bottom:4px solid var(--red);box-shadow:0 2px 12px rgba(0,0,0,.08)}
    .topbar-inner{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px;padding:10px 16px}
    .brand-left img{height:54px;width:auto;display:block}
    .logo-right img{height:68px;width:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
    .title{font-weight:800;letter-spacing:.4px;text-transform:uppercase;font-size:clamp(18px,2.6vw,28px);text-align:left}

    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns: 340px 1fr;gap:16px}
    .card{background:var(--card);border:2px solid var(--gold-dark);border-radius:18px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .card h3{margin:0 0 10px;font-size:18px;font-weight:800;color:var(--red)}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .row.two{grid-template-columns:1fr 1fr}
    label{display:grid;gap:6px;font-weight:600}
    input,textarea{padding:10px 12px;font-size:16px;border-radius:12px;border:2px solid var(--ring);background:#fff;outline:none}
    input:focus,textarea:focus{border-color:var(--gold-dark);box-shadow:0 0 0 3px rgba(242,180,0,.2)}
    textarea{min-height:90px;resize:vertical}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;transition:.2s transform ease,.2s box-shadow ease;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--red);color:#fff;border:2px solid var(--red-dark)}
    .btn-outline{background:#fff;color:#111;border:2px solid var(--ring)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .locked [data-editable="true"]{opacity:.6}
    .status{margin-top:10px;font-weight:600}

    .card-password{min-width:300px}
    .pw-row{display:flex;gap:10px;align-items:center}
    .pw-row input[type=password], .pw-row input[type=text]{flex:1;min-width:0}
    .pw-toggle{display:inline-flex;gap:6px;align-items:center;font-size:14px;color:#333;white-space:nowrap}

    @media (max-width: 1024px){
      .brand-left img{height:48px}
      .logo-right img{height:60px}
      .grid{grid-template-columns:300px 1fr}
    }
    @media (max-width: 820px){
      .topbar-inner{grid-template-columns:auto 1fr auto}
      .brand-left img{height:42px}
      .logo-right img{height:54px}
      .grid{grid-template-columns:1fr;gap:14px}
      .card-password{min-width:100%}
      .row.two{grid-template-columns:1fr}
    }
    @media (max-width: 420px){
      .brand-left img{height:36px}
      .logo-right img{height:46px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand-left"><img src="refresco_logo.jpg" alt="Refresco"></div>
      <div class="title">Segnalazioni Qualità – Sulmona</div>
      <div class="logo-right"><img src="logo_quality.png" alt="Qualità"></div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <div>
        <div class="card card-password">
          <h3>Modalità modifica</h3>
          <div class="row">
            <div class="pw-row">
              <input type="password" id="edit-password" placeholder="Password"/>
              <label class="pw-toggle"><input type="checkbox" id="togglePw"> Mostra</label>
            </div>
            <div class="row two">
              <button class="btn btn-primary" id="unlock">Sblocca</button>
              <button class="btn btn-outline" id="lock" disabled>Blocca</button>
            </div>
          </div>
          <div id="lock-status" class="status muted">Bloccato: sola lettura</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Sanificazioni</h3>
          <form id="form" class="locked">
            <div class="row two">
              <label>Data Sanificazione 81
                <input type="date" id="data_sanificazione_81" data-editable="true"/>
              </label>
              <label>Data Sanificazione 82
                <input type="date" id="data_sanificazione_82" data-editable="true"/>
              </label>
            </div>
            <div class="row two">
              <label>Data Sanificazione 83
                <input type="date" id="data_sanificazione_83" data-editable="true"/>
              </label>
              <label>Data Sanificazione 84
                <input type="date" id="data_sanificazione_84" data-editable="true"/>
              </label>
            </div>

            <h3 style="margin-top:10px">Segnalazioni</h3>
            <label>Segnalazione 81
              <textarea id="segnalazione_81" data-editable="true" placeholder="Testo"></textarea>
            </label>
            <label>Segnalazione 82
              <textarea id="segnalazione_82" data-editable="true" placeholder="Testo"></textarea>
            </label>
            <label>Segnalazione 83
              <textarea id="segnalazione_83" data-editable="true" placeholder="Testo"></textarea>
            </label>
            <label>Segnalazione 84
              <textarea id="segnalazione_84" data-editable="true" placeholder="Testo"></textarea>
            </label>

            <div class="row two" style="margin-top:8px">
              <button class="btn btn-outline" type="button" id="load">Carica</button>
              <button class="btn btn-primary" type="submit" id="save" disabled>Salva</button>
            </div>
            <div id="status" class="status muted"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl='https://orttbxpxuohxfsqwrzcy.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ydHRieHB4dW9oeGZzcXdyemN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDAxMTksImV4cCI6MjA2NjQxNjExOX0.Lxe0r28sb4-JYRasIJJU13uq8sfiGSeNTeuWC98_wCs';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);
    const EDIT_PASSWORD='quality';
    const el=id=>document.getElementById(id);
    const form=el('form'); const saveBtn=el('save');
    let isUnlocked=false; let currentId=null;

    function setLockedState(locked){
      isUnlocked=!locked;
      form.classList.toggle('locked',locked);
      form.querySelectorAll('[data-editable="true"]').forEach(i=>i.disabled=locked);
      saveBtn.disabled=locked;
      el('unlock').disabled=!locked?true:false;
      el('lock').disabled=locked;
      el('lock-status').textContent=locked?'Bloccato: sola lettura':'Sbloccato: puoi modificare e salvare';
    }
    setLockedState(true);

    el('togglePw').addEventListener('change',e=>{el('edit-password').type=e.target.checked?'text':'password'});
    el('unlock').addEventListener('click',()=>{const pwd=el('edit-password').value.trim(); if(pwd===EDIT_PASSWORD){setLockedState(false)} else {el('lock-status').textContent='Password errata'}})
    el('lock').addEventListener('click',()=>setLockedState(true))

    function setFormValues(row){
      el('data_sanificazione_81').value=row.data_sanificazione_81??'';
      el('data_sanificazione_82').value=row.data_sanificazione_82??'';
      el('data_sanificazione_83').value=row.data_sanificazione_83??'';
      el('data_sanificazione_84').value=row.data_sanificazione_84??'';
      el('segnalazione_81').value=row.segnalazione_81??'';
      el('segnalazione_82').value=row.segnalazione_82??'';
      el('segnalazione_83').value=row.segnalazione_83??'';
      el('segnalazione_84').value=row.segnalazione_84??'';
    }

    async function loadRow(){
      const {data,error}=await supabase.from('segnalazioni_qualita').select('*').order('id',{ascending:true}).limit(1).maybeSingle();
      if(error){el('status').textContent='Errore caricamento: '+error.message; return;}
      if(!data){el('status').textContent='Nessuna riga presente: contatta l’amministratore per crearla.'; currentId=null; setFormValues({}); return;}
      currentId=data.id; setFormValues(data); el('status').textContent='Dati caricati.';
    }
    el('load').addEventListener('click',loadRow);
    window.addEventListener('DOMContentLoaded',loadRow);

    form.addEventListener('submit',saveRow);
    async function saveRow(ev){
      ev.preventDefault();
      if(!isUnlocked){el('status').textContent='Inserisci la password per salvare.'; return;}
      if(!currentId){el('status').textContent='Nessuna riga da aggiornare.'; return;}
      const payload={
        data_sanificazione_81: el('data_sanificazione_81').value || null,
        data_sanificazione_82: el('data_sanificazione_82').value || null,
        data_sanificazione_83: el('data_sanificazione_83').value || null,
        data_sanificazione_84: el('data_sanificazione_84').value || null,
        segnalazione_81: el('segnalazione_81').value || null,
        segnalazione_82: el('segnalazione_82').value || null,
        segnalazione_83: el('segnalazione_83').value || null,
        segnalazione_84: el('segnalazione_84').value || null
      };
      const {error}=await supabase.from('segnalazioni_qualita').update(payload).eq('id',currentId);
      if(error){el('status').textContent='Errore salvataggio: '+error.message; return;}
      el('status').textContent='Salvato correttamente ✔';
      loadRow();
    }
  </script>
</body>
</html>

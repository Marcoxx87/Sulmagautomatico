<?php
require_once __DIR__ . '/auth.php';
?>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TV Dashboard ‚Äì KPI + Rotazione</title>
  <link rel="icon" href="refresco_logo.jpg" type="image/jpg">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#f6921e;--brand-dark:#d67500;--brand-green:#43a047;--ok:#2e7d32;--warn:#f9a825;--danger:#d32f2f;--ink:#1b2440;--muted:#5a6a85;--ring:#f6921e;--ring-rest:#eef2f7;--header-h:5mm}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font-family:Outfit,system-ui,Segoe UI,Arial,sans-serif}
    header{display:block;min-height:var(--header-h);height:var(--header-h);background:linear-gradient(90deg,var(--brand),var(--brand-dark))}
    header .hidden{display:none}
    .layout{display:grid;grid-template-columns:310px 1fr 310px;grid-template-rows:calc(100dvh - var(--header-h) - 200px);gap:14px;padding:14px;height:calc(100dvh - var(--header-h) - 200px)}
    .col{display:flex;flex-direction:column;gap:14px;min-width:0}
    .card{background:#fff;border:2px solid var(--brand-green);border-radius:16px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .kpi{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
    .kpi .label{font-size:16px;color:var(--muted);font-weight:700}
    .kpi .value{font-size:44px;font-weight:900}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.danger{color:var(--danger)}
    .status{font-size:34px;font-weight:900}
    .center{display:flex;flex-direction:column;gap:14px;min-width:0}
    .bar{display:flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:12px;background:#fff;border:2px solid var(--brand-green)}
    .label-url{font-weight:900;text-align:center;max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .viewer{position:relative;flex:1;min-height:0;border-radius:18px;overflow:hidden;border:2px solid var(--brand-green);background:#fff}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:#fff}
    .alert{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.6)}
    .alert.show{display:flex}
    .alert .txt{font-size:86px;font-weight:900;color:#fff;padding:14px 22px;border-radius:14px;background:#ff3b3b;border:4px solid #b30000;box-shadow:0 8px 30px rgba(179,0,0,.35)}
    .blink{animation:blink 1s infinite}
    @keyframes blink{50%{opacity:.4}}
    .gcard .gtitle{font-weight:900;margin-bottom:8px;color:var(--muted)}
    .gwrap{display:flex;align-items:center;gap:12px}
    .gauge{position:relative;width:140px;height:140px;border-radius:50%;background:conic-gradient(var(--ring) 0%, var(--ring-rest) 0%)}
    .gauge::after{content:"";position:absolute;inset:14px;border-radius:50%;background:#fff;box-shadow:inset 0 0 10px rgba(0,0,0,.06);z-index:1}
    .glabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:var(--ink);z-index:2}
    .gmeta{font-weight:800;color:var(--muted)}
    .meteo-title{font-weight:900;margin-bottom:8px;color:var(--muted)}
    .meteo{display:flex;align-items:center;gap:12px}
    .meteo .temp{font-size:36px;font-weight:900}
    .meteo .desc{font-weight:800;color:var(--muted)}
    .ticker{padding:10px 12px;border-radius:12px;background:#fff;border:2px solid var(--brand-green);min-height:54px;display:flex;align-items:center;justify-content:center;font-weight:900}
    .ticker a{color:#0b5cab;text-decoration:none}
    .small-list .kv{display:inline-block;margin:0 .6rem .25rem 0;white-space:nowrap;font-size:13px}
    .small-list .kv::before{content:"‚Ä¢ ";font-weight:900;margin-right:.1rem}
    .bottom-panels{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:0 14px 14px}
    @media (max-width:1100px){.layout{grid-template-rows:calc(100dvh - var(--header-h) - 320px)}.bottom-panels{grid-template-columns:1fr}}
    .safety-title{text-align:center;font-weight:900;margin-bottom:8px;color:var(--muted)}
    .safety-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:1100px){.safety-row{grid-template-columns:1fr}}
    .safety-col{display:flex;flex-direction:column;gap:8px}
    .s-pill{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#fff;border:2px solid var(--brand-green);border-radius:12px}
    .s-pill .lab{font-weight:900;color:var(--ink);font-size:16px;white-space:nowrap}
    .s-pill .val{font-weight:900;font-size:20px;color:var(--ink)}
    .quality-title{text-align:center;font-weight:900;margin-bottom:8px;color:var(--muted)}
    .quality-row{display:flex;flex-direction:column;gap:6px}
    .quality-item{border:2px solid var(--brand-green);border-radius:12px;padding:6px 8px;background:#fff;display:flex;gap:10px;align-items:baseline}
    .q-lab{font-weight:900;color:var(--ink);min-width:84px}
    .q-val{display:flex;gap:6px;align-items:baseline;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .q-pre{font-weight:500;color:var(--ink);opacity:.9}
    .q-date{font-weight:900}
    .q-sep{opacity:.5}
    .q-note{font-size:14px;font-weight:400;opacity:.95}
    .bottom-panels .card{padding:10px}
    .brand-clock{position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;height:110px;padding:0;border:2px solid var(--brand-green)}
    .brand-clock::before{content:"";position:absolute;inset:0;background:url('refresco_logo.jpg') center/cover no-repeat;opacity:.18;filter:saturate(1.1)}
    .brand-clock .clock-wrap{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 16px;text-align:center}
    .brand-clock .clock-title{font-weight:900;color:var(--muted);margin-bottom:4px}
    .brand-clock .big-clock{font-size:52px;line-height:1;font-weight:900;color:var(--ink)}
    .brand-clock .date{margin-top:4px;font-weight:800;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="hidden"><img src="refresco_logo.jpg" alt="Refresco" height="1"></div>
    <div class="hidden title">TV DASHBOARD ‚Ä¢ KPI & OEE ‚Ä¢ LIVE</div>
    <div class="hidden clock" id="clock">--:--:--</div>
  </header>
  <div class="layout">
    <div class="col">
      <div class="card brand-clock">
        <div class="clock-wrap">
          <div class="clock-title">Ora attuale</div>
          <div class="big-clock" id="big-clock">--:--:--</div>
          <div class="date" id="big-date">‚Äî ‚Äî‚Äî‚Äî‚Äî ‚Äî‚Äî‚Äî‚Äî</div>
        </div>
      </div>
      <div class="card kpi"><div class="label">Fermi attivi</div><div class="value" id="kpi-fermi">‚Äî</div></div>
      <div class="card kpi" style="display:none"><div class="label">Carwash</div><div id="kpi-cw-status" class="status ok">OK</div></div>
      <div class="card kpi">
        <div class="label">Spedizioni attive</div><div class="value" id="kpi-sped">‚Äî</div>
        <div class="label" id="kpi-sped-mini" style="grid-column:1/-1">Media avanzamento: ‚Äî</div>
        <div class="label" id="kpi-ot-mini" style="grid-column:1/-1">Pallet in uscita per spedizioni: ‚Äî</div>
      </div>
      <div class="card gcard"><div class="gtitle">Occupazione Baie</div><div class="gwrap"><div class="gauge" id="gauge-baie"><div class="glabel" id="gauge-baie-txt">‚Äî%</div></div><div class="gmeta" id="gauge-baie-meta">‚Äî/17</div></div></div>
      <div class="card gcard"><div class="gtitle">Locazioni bloccate</div><div class="gwrap"><div class="gauge" id="gauge-loc"><div class="glabel" id="gauge-loc-txt">‚Äî%</div></div><div class="gmeta" id="gauge-loc-meta">‚Äî/12884</div></div></div>
    </div>
    <div class="center">
      <div class="bar card"><div class="label-url" id="url-label">‚Äî</div></div>
      <div class="viewer">
        <iframe id="rotor" title="Rotazione embed"></iframe>
        <div class="alert" id="cw-alert"><div class="txt blink">CARWASH PIENO</div></div>
      </div>
    </div>
    <div class="col">
      <div class="card kpi">
        <div class="label">Pallet in Carwash (oggi)</div>
        <div class="value" id="kpi-cw">‚Äî</div>
        <div class="small-list" id="kpi-cw-mini">‚Äî</div>
      </div>
      <div class="card gcard"><div class="gtitle">Saturazione Magazzino</div><div class="gwrap"><div class="gauge" id="gauge-sat"><div class="glabel" id="gauge-sat-txt">‚Äî%</div></div><div class="gmeta" id="gauge-sat-meta">‚Äî/31540</div></div></div>
      <div class="card kpi" id="gest-card">
        <div class="label">Pallet da Gestire</div>
        <div class="value" id="gest-tot">‚Äî</div>
        <div class="small-list" id="gest-mini" style="grid-column:1/-1">‚Äî</div>
      </div>
      <div class="card"><div class="meteo-title">Meteo ‚Ä¢ Sulmona</div><div class="meteo"><div class="temp" id="meteo-temp">‚Äî¬∞C</div><div><div class="desc" id="meteo-desc">‚Äî</div><div class="desc" id="meteo-wind">‚Äî</div></div></div></div>
      <div class="card"><div class="meteo-title">Ultime notizie</div><div class="ticker" id="news-ticker">‚Äî</div></div>
    </div>
  </div>
  <div class="bottom-panels">
    <div class="card" id="safety-card">
      <div class="safety-title">Sicurezza</div>
      <div class="safety-row" id="safety-row"></div>
    </div>
    <div class="card" id="quality-card">
      <div class="quality-title">Qualit√†</div>
      <div class="quality-row" id="quality-row"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const $=id=>document.getElementById(id);
    const sb=window.supabase.createClient('https://orttbxpxuohxfsqwrzcy.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ydHRieHB4dW9oeGZzcXdyemN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDAxMTksImV4cCI6MjA2NjQxNjExOX0.Lxe0r28sb4-JYRasIJJU13uq8sfiGSeNTeuWC98_wCs');

    function updateTime(){
      const now=new Date();
      const hh=now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const dd=now.toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const b=$('big-clock');if(b)b.textContent=hh;
      const bd=$('big-date');if(bd)bd.textContent=dd;
      const h=$('clock');if(h)h.textContent=hh;
    }
    setInterval(updateTime,1000);updateTime();

    function cls(v,w,d){if(v>=d)return'danger';if(v>=w)return'warn';return'ok'}
    function setKpi(id,val,c){const el=$(id);if(!el)return;el.textContent=val;if(c)el.className='value '+c}
    function gaugeColor(p,better='high',th={good:70,warn:90}){if(better==='low'){if(p<=th.good)return'var(--ok)';if(p<=th.warn)return'var(--warn)';return'var(--danger)'}if(p>=th.good)return'var(--ok)';if(p>=th.warn)return'var(--warn)';return'var(--danger)'}
    function setGauge(baseId,percent,metaText,better='high',th={good:70,warn:90}){const ring=$(baseId),txt=$(baseId+'-txt'),meta=$(baseId+'-meta');if(!ring||!txt)return;const p=Math.max(0,Math.min(100,Math.round(percent)));const col=gaugeColor(p,better,th);ring.style.background=`conic-gradient(${col} ${p}%, var(--ring-rest) 0)`;txt.textContent=p+'%';if(meta)meta.textContent=metaText||''}

    async function loadKpi(){
      try{
        const now=new Date();
        const start=new Date(now); start.setHours(0,0,0,0);

        const ferm=await sb.from('fermi_act').select('*',{count:'exact'});
        const f=ferm.count||0;
        setKpi('kpi-fermi',f,cls(f,1,3));

        const cwFull=(ferm.data||[]).some(r=>/segment\s*:\s*969\s*;\s*point\s*755/i.test(String(r.AlarmDetails||'')));
        const resiFull=(ferm.data||[]).some(r=>/segment\s*:\s*2526\s*;\s*point\s*1629/i.test(String(r.AlarmDetails||'')));

        const cwStatus=$('kpi-cw-status');
        if(cwStatus){
          let statusTxt='OK';
          let statusClass='ok';
          if(cwFull && resiFull){ statusTxt='CARWASH + RESI UP PIENI'; statusClass='danger'; }
          else if(cwFull){ statusTxt='CARWASH PIENO'; statusClass='danger'; }
          else if(resiFull){ statusTxt='RESI UP PIENO'; statusClass='danger'; }
          cwStatus.textContent=statusTxt;
          cwStatus.className='status '+statusClass;
        }

        const alertEl=$('cw-alert');
        if(alertEl){
          const msg=(cwFull && resiFull) ? 'CARWASH E RESI UP PIENI'
                 : cwFull ? 'CARWASH PIENO'
                 : resiFull ? 'RESI UP PIENO'
                 : '';
          alertEl.querySelector('.txt').textContent=msg||'';
          alertEl.classList.toggle('show', !!msg);
        }

        const sp=await sb.from('shipment_pallets').select('*');
        const done=['Completato','Completed','Closed','Fatto','Finito'].map(x=>x.toLowerCase());
        const by={};
        (sp.data||[]).forEach(r=>{
          const k=r.ShipmentNumber;
          if(!by[k])by[k]={prev:0,cons:0,status:(r.ShipmentStatusDescription||''),raw:[]};
          by[k].prev=r.PalletPrevisti||by[k].prev;
          by[k].cons=r.PalletConsegnati||by[k].cons;
          if(r.ShipmentStatusDescription)by[k].status=r.ShipmentStatusDescription;
          by[k].raw.push(r);
        });
        const rows=Object.values(by);
        const att=rows.filter(s=>!done.includes(String(s.status||'').toLowerCase()));
        const media=att.length?Math.round(att.reduce((a,b)=>a+(b.prev?(b.cons/b.prev)*100:0),0)/att.length):0;
        setKpi('kpi-sped',att.length,cls(att.length,3,8));
        $('kpi-sped-mini').textContent=`Media avanzamento: ${media}%`;

        const attesa=await sb.from('shipment_attesa').select('*');
        $('kpi-ot-mini').textContent=`Pallet in uscita per spedizioni: ${(attesa.data||[]).length}`;

        const bays=new Set();
        att.forEach(s=>s.raw.forEach(r=>{const v=(r.StagingAreaName||'').toString().trim();if(v)bays.add(v)}));
        setGauge('gauge-baie',Math.min(100,Math.round((bays.size/17)*100)),`${bays.size}/17`,'low',{good:50,warn:80});

        const cwAll=await sb.from('pallet_storico_new').select('StorageLocation,EnterDateTime,Partenza').order('EnterDateTime',{ascending:false});
        const list=(cwAll.data||[])
          .filter(r=>{
            const t=new Date(r.EnterDateTime);
            return !isNaN(t) && t>=start && t<=now;
          })
          .map(r=>({
            loc:String(r.StorageLocation||'').toUpperCase(),
            src:(r.Partenza??r.partenza??'').toString().trim()||'‚Äî'
          }));
        const cwMain=list.filter(x=>x.loc==='CW');
        const cwDown=list.filter(x=>x.loc==='CW_DOWN');
        const wanted=[
          {key:'PICK_CO_PACK',label:'CO_PACK'},
          {key:'PICK_LINEA_84',label:'Linea 84'},
          {key:'PICK_LINEA_83',label:'Linea 83'},
          {key:'PICK_LINEA_82',label:'Linea 82'},
          {key:'PICK_LINEA_81',label:'Linea 81'}
        ];
        const srcMap={}; cwMain.forEach(x=>{srcMap[x.src]=(srcMap[x.src]||0)+1});
        const sel=wanted.map(w=>({label:w.label,val:(srcMap[w.key]||0)}));
        const selSum=sel.reduce((a,b)=>a+b.val,0);
        const other=Math.max(0,cwMain.length-selSum);
        const cwMainCnt=cwMain.length, cwDownCnt=cwDown.length, tot=cwMainCnt+cwDownCnt;
        setKpi('kpi-cw',tot,cls(tot,20,60));
        $('kpi-cw-mini').innerHTML=[
          `<b>CW: ${cwMainCnt}</b>`,
          ...sel.filter(s=>s.val>0).map(s=>`<span class="kv">${s.label}: ${s.val}</span>`),
          other>0?`<span class="kv">Altro: ${other}</span>`:'',
          `<br><b>DOWN: ${cwDownCnt}</b>`
        ].filter(Boolean).join(' ');

        const totP=await sb.from('totale_articoli').select('NumPallet');
        const pallets=(totP.data||[]).reduce((s,r)=>s+Number(r.NumPallet||0),0);
        const cap=31540;
        const sat=cap?Math.round((pallets/cap)*100):0;
        setGauge('gauge-sat',sat,`${pallets}/${cap}`,'low',{good:50,warn:80});

        const loc=await sb.from('magazzino_stato').select('PRELIEVO_DISABILITATO,DEPOSITO_DISABILITATO,LOCAZIONE');
        const bloc=(loc.data||[]).filter(r=>r.PRELIEVO_DISABILITATO||r.DEPOSITO_DISABILITATO);
        const totalDisp=12884;
        const percBloc=totalDisp?Math.round((bloc.length/totalDisp)*100):0;
        setGauge('gauge-loc',percBloc,`${bloc.length}/${totalDisp}`,'low',{good:2,warn:5});
      }catch(e){console.error(e)}
    }

    async function loadPalletDaGestire(){
      try{
        let spezz=0;
        const tables=['spezzature_magazzino','spezzature','t_spezzature','spezzature_totali'];
        for(const t of tables){
          const r=await sb.from(t).select('*',{count:'exact'}).limit(1);
          if(!r.error && typeof r.count==='number'){spezz=r.count;break}
        }

        let scaduti=0;
        { const r=await sb.from('Pallet_Scaduti').select('*',{count:'exact'}).limit(1);
          if(!r.error && typeof r.count==='number') scaduti=r.count; }

        let shelfFM=0;
        { const r=await sb
            .from('pallet_shelf_life')
            .select('*',{count:'exact'})
            .or('DescrizioneFamiglia.ilike.%finito%,DescrizioneFamiglia.ilike.%mix%')
            .limit(1);
          if(!r.error && typeof r.count==='number') shelfFM=r.count; }

        const tot = spezz + scaduti + shelfFM;
        $('gest-tot').textContent = tot;
        $('gest-tot').className = 'value ' + (tot>=100 ? 'danger' : (tot>=40 ? 'warn' : 'ok'));
        $('gest-mini').innerHTML = [
          `<span class="kv"><b>Spezzature:</b> ${spezz}</span>`,
          `<span class="kv"><b>Scaduti:</b> ${scaduti}</span>`,
          `<span class="kv"><b>ShelfLife finito/mix:</b> ${shelfFM}</span>`
        ].join(' ');
      }catch(e){
        $('gest-tot').textContent='‚Äî';
        $('gest-mini').textContent='‚Äî';
        console.error(e);
      }
    }

    async function loadSafety(){
      const y=new Date().getFullYear();
      try{
        const r=await sb.from('indicatori_infortuni').select('numero_infortuni,giorni_persi_infortunio,segnalazioni_mese,segnalazioni_totali_anno,percentuale_chiusura_anno,data_ultimo_infortunio,anno,mese').eq('anno',y).order('mese',{ascending:false}).limit(1);
        const d=(r.data||[])[0]||{};
        const fmt=v=>v==null?'‚Äî':String(v);
        const pct=(d.percentuale_chiusura_anno!=null)?`${Number(d.percentuale_chiusura_anno).toFixed(0)}%`:'‚Äî';
        let giorniSenza='‚Äî';
        if(d.data_ultimo_infortunio){
          const last=new Date(String(d.data_ultimo_infortunio).split('T')[0]);
          const today=new Date(); today.setHours(0,0,0,0);
          const diffMs=today-last; if(!isNaN(diffMs))giorniSenza=Math.max(0,Math.floor(diffMs/(1000*60*60*24)));
        }
        const left=[{lab:`Numero infortuni ${y}`,val:fmt(d.numero_infortuni)},{lab:'Giorni senza infortunio',val:fmt(giorniSenza)},{lab:'Giorni persi per infortunio',val:fmt(d.giorni_persi_infortunio)}];
        const right=[{lab:'Segnalazioni del mese',val:fmt(d.segnalazioni_mese)},{lab:'Tot segnalazioni anno',val:fmt(d.segnalazioni_totali_anno)},{lab:'% chiusura segnalazioni anno',val:pct}];
        const pill=x=>`<div class="s-pill"><div class="lab">${x.lab}</div><div class="val">${x.val}</div></div>`;
        $('safety-row').innerHTML=`<div class="safety-col">${left.map(pill).join('')}</div><div class="safety-col">${right.map(pill).join('')}</div>`;
      }catch(e){console.error(e)}
    }

    async function loadQuality(){
      try{
        const r=await sb.from('segnalazioni_qualita').select('*').order('creato_il',{ascending:false}).limit(1);
        const d=(r.data||[])[0]||{};
        const fmtDate=v=>v?new Date(String(v).split('T')[0]).toLocaleDateString('it-IT'):'‚Äî';
        const fmtTxt=v=>v&&String(v).trim()?String(v).trim():'‚Äî';
        const lines=[
          {line:81,date:d.data_sanificazione_81,note:d.segnalazione_81},
          {line:82,date:d.data_sanificazione_82,note:d.segnalazione_82},
          {line:83,date:d.data_sanificazione_83,note:d.segnalazione_83},
          {line:84,date:d.data_sanificazione_84,note:d.segnalazione_84}
        ];
        $('quality-row').innerHTML=lines.map(x=>`<div class="quality-item" title="${fmtTxt(x.note)}"><div class="q-lab">Linea ${x.line}</div><div class="q-val"><span class="q-pre">Sanificata il</span><span class="q-date">${fmtDate(x.date)}</span><span class="q-sep">‚Äî</span><span class="q-pre" style="font-weight:400">Ultima segnalazione:</span><span class="q-note">${fmtTxt(x.note)}</span></div></div>`).join('');
      }catch(e){console.error(e)}
    }

    loadKpi(); setInterval(loadKpi,30000);
    loadPalletDaGestire(); setInterval(loadPalletDaGestire,60000);
    loadSafety(); setInterval(loadSafety,300000);
    loadQuality(); setInterval(loadQuality,300000);
  </script>

  <script>
    async function loadMeteo(){
      try{
        const res=await fetch('https://api.open-meteo.com/v1/forecast?latitude=42.05&longitude=13.93&current=temperature_2m,weather_code,wind_speed_10m',{cache:'no-store'});
        const j=await res.json(); const c=j.current||{};
        const wmap={0:'Sereno ‚òÄÔ∏è',1:'Poco nuvoloso üå§Ô∏è',2:'Variabile ‚õÖ',3:'Nuvoloso ‚òÅÔ∏è',45:'Nebbia üå´Ô∏è',48:'Nebbia üå´Ô∏è',51:'Pioviggine üå¶Ô∏è',53:'Pioviggine üå¶Ô∏è',55:'Pioviggine üå¶Ô∏è',61:'Pioggia üåßÔ∏è',63:'Pioggia üåßÔ∏è',65:'Pioggia üåßÔ∏è',71:'Neve ‚ùÑÔ∏è',73:'Neve ‚ùÑÔ∏è',75:'Neve ‚ùÑÔ∏è',80:'Rovesci üåßÔ∏è',81:'Rovesci üåßÔ∏è',82:'Rovesci üåßÔ∏è',95:'Temporali ‚õàÔ∏è',96:'Temporali ‚õàÔ∏è',99:'Temporali ‚õàÔ∏è'};
        document.getElementById('meteo-temp').textContent=(c.temperature_2m!=null?Math.round(c.temperature_2m):'‚Äî')+'¬∞C';
        document.getElementById('meteo-desc').textContent=wmap[c.weather_code]||'‚Äî';
        document.getElementById('meteo-wind').textContent='Vento: '+(c.wind_speed_10m!=null?Math.round(c.wind_speed_10m)+' km/h':'‚Äî');
      }catch(e){
        document.getElementById('meteo-temp').textContent='‚Äî¬∞C';
        document.getElementById('meteo-desc').textContent='‚Äî';
        document.getElementById('meteo-wind').textContent='‚Äî';
      }
    }
    loadMeteo(); setInterval(loadMeteo,600000);

    let newsItems=[],newsIdx=0;
    function cleanText(s){return(s||'').replace(/<[^>]*>/g,' ').replace(/&[^;]+;/g,' ').replace(/\s+/g,' ').trim()}
    function parseXmlItems(txt){
      try{
        const xml=new DOMParser().parseFromString(txt,'text/xml');
        const items=[...xml.querySelectorAll('item')].map(it=>({t:cleanText(it.querySelector('title')?.textContent),l:cleanText(it.querySelector('link')?.textContent)})).filter(i=>i.t&&i.l);
        if(items.length)return items;
      }catch(e){}
      const blocks=[...txt.matchAll(/<item[\s\S]*?<\/item>/gi)].map(m=>m[0]);
      return blocks.map(b=>{
        const t=(b.match(/<title>([\s\S]*?)<\/title>/i)||[])[1]||'';
        const l=(b.match(/<link>(https?:[\s\S]*?)<\/link>/i)||[])[1]||'#';
        return{t:cleanText(t),l:cleanText(l)}
      }).filter(i=>i.t&&/^https?:\/\//.test(i.l))
    }
    function filterNews(arr){const bad=/cookie|consenso|privacy|informativa/i;return arr.filter(i=>!bad.test(i.t))}
    async function fetchViaAllOrigins(u){const r=await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(u),{cache:'no-store'});if(!r.ok)throw new Error('origins');return await r.text()}
    async function fetchViaJina(u){const r=await fetch('https://r.jina.ai/'+u,{cache:'no-store'});if(!r.ok)throw new Error('jina');return await r.text()}
    async function fetchViaRss2Json(u){const r=await fetch('https://api.rss2json.com/v1/api.json?count=25&rss_url='+encodeURIComponent(u),{cache:'no-store'});if(!r.ok)throw new Error('rss2json');const j=await r.json();if(!j.items?.length)throw new Error('empty');return j.items.map(it=>({t:cleanText(it.title),l:it.link}))}
    async function loadFromSource(src){
      try{const txt=await fetchViaAllOrigins(src);const items=parseXmlItems(txt);if(items.length)return filterNews(items)}catch(e){}
      try{const txt=await fetchViaJina(src);const items=parseXmlItems(txt);if(items.length)return filterNews(items)}catch(e){}
      try{const items=await fetchViaRss2Json(src);if(items.length)return filterNews(items)}catch(e){}
      return []
    }
    async function loadNews(){
      const sources=['https://www.ansa.it/sito/ansait_rss.xml','https://www.ilsole24ore.com/rss/notizie.xml','https://www.repubblica.it/rss/homepage/rss2.0.xml','https://feeds.bbci.co.uk/news/world/rss.xml'];
      for(const s of sources){
        const items=await loadFromSource(s);
        if(items.length){newsItems=items.slice(0,30);newsIdx=0;renderTicker();return}
      }
      newsItems=[{t:'Notizie non disponibili',l:'#'}];renderTicker()
    }
    function renderTicker(){
      const t=document.getElementById('news-ticker');
      if(!t||!newsItems.length){t.textContent='‚Äî';return}
      const it=newsItems[newsIdx%newsItems.length];
      t.innerHTML=`<a href="${it.l}" target="_blank" rel="noopener">${it.t}</a>`;
      newsIdx++
    }
    loadNews(); setInterval(renderTicker,8000); setInterval(loadNews,600000);

    const PAGES=[
      {url:'https://80.21.24.216:594/OEEblueDashboard_Sulmona/PlantDashboard.aspx',label:'OEEblue ‚Äì Plant Dashboard',popup:false},
      {url:'https://80.21.24.216:594/OEEblueDashboard_Sulmona/LineDashboard.aspx?MachineID=97',label:'OEEblue ‚Äì LINEA 81',popup:false},
      {url:'https://80.21.24.216:594/OEEblueDashboard_Sulmona/LineDashboard.aspx?MachineID=100',label:'OEEblue ‚Äì LINEA 82',popup:false},
      {url:'https://80.21.24.216:594/OEEblueDashboard_Sulmona/LineDashboard.aspx?MachineID=109',label:'OEEblue ‚Äì LINEA 83',popup:false},
      {url:'https://80.21.24.216:594/OEEblueDashboard_Sulmona/LineDashboard.aspx?MachineID=106',label:'OEEblue ‚Äì LINEA 84',popup:false},
      {url:'Carwash.html',label:'Carwash',popup:false},
      {url:'shipment.html',label:'Spedizioni',popup:false},
      {url:'fermate.html',label:'Fermate',popup:false}
    ];
    const INTERVAL=30000;
    const frame=document.getElementById('rotor'),urlL=document.getElementById('url-label');
    let idx=0,timer=null;
    function show(k){idx=(k+PAGES.length)%PAGES.length;const p=PAGES[idx];urlL.textContent=p.label||p.url;frame.src=p.url}
    function next(){show(idx+1)}
    function start(){if(timer)clearInterval(timer);timer=setInterval(next,INTERVAL)}
    function init(){show(0);start()}
    init();
  </script>
</body>
</html>
